<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-align-items: start; justify-content: flex-start; text-align: left; color: #333; font-family: Arial, sans-serif;"
    />
    <title>Одномерная задача раскроя</title>
    <script src="https://unpkg.com/vue@3"></script>
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <div id="app">
      <h1>Одномерная задача раскроя</h1>

      <div class="form-group">
        <h2>Исходные данные заготовки</h2>
        <label for="stockLength">Длина заготовки (мм):</label>
        <input type="number" v-model="stockLength" id="stockLength" min="1" />
        <label for="stockQuantity">Количество заготовок:</label>
        <input
          type="number"
          v-model="stockQuantity"
          id="stockQuantity"
          min="1"
        />
        <div class="form-group">
          <label for="gap">Общий зазор (мм):</label>
          <input type="number" v-model="gap" id="gap" min="0" step="0.1" />
        </div>
        <p>Суммарная длина заготовок: {{stockLength*stockQuantity}} мм</p>
        <p>Суммарная длина деталей: {{totalLength}} мм</p>
      </div>

      <div class="form-group">
        <h2>Детали</h2>
        <div v-for="(detail, index) in details" :key="index">
          <label>Деталь {{ index + 1 }}: Длина (мм)</label>
          <input type="number" v-model="detail.length" min="1" />
          <label>Количество</label>
          <input type="number" v-model="detail.quantity" min="1" />
          <label>Комментарий</label>
          <input
            type="text"
            v-model="detail.comment"
            placeholder="Комментарий"
          />
          <button @click="removeDetail(index)">Удалить деталь</button>
        </div>
        <button @click="addDetail">Добавить деталь</button>
      </div>

      <button @click="calculateCutting">Рассчитать раскрой</button>
      <button @click="saveToCSV">Сохранить в CSV</button>
      <input style="width: 10cm;" type="file" @change="loadFromCSV" accept=".csv" />

      <div v-if="cuttingPlan.length > 0" class="cutting-visual">
        <h2>Результаты раскроя</h2>
        <div
          v-for="(stock, stockIndex) in uniqueCuttingPlans"
          :key="stockIndex"
          class="bar"
        >
          <div>Число повторов: {{ stock.repeats }}</div>
          <div
            v-for="(segment, index) in stock.segments"
            :key="index"
            class="segment"
            :style="{ width: segment.width + '%', left: segment.left + '%' }"
          >
            №{{ segment.position }} L={{ segment.length }} мм <br />
            {{segment.comment}}
          </div>
          <div
            v-if="stock.remainder > 0"
            class="remainder"
            :style="{ width: stock.remainderWidth + '%', left: stock.remainderLeft + '%' }"
          >
            Остаток: {{ stock.remainder }} мм
          </div>
        </div>

        <div class="result">
          Процент неиспользованных остатков: {{ unusedPercentage.toFixed(2) }}%
        </div>

        <div class="result">
          Всего деталей: {{ totalDetails }} штук<br />
          Расположено: {{ placedDetails }} штук<br />
          Не расположено: {{ totalDetails - placedDetails }} штук
        </div>
      </div>
    </div>

    <script>
      const { createApp, ref, computed } = Vue;

      createApp({
        setup() {
          const gap = ref(5);// Общее значение зазора для всех деталей
          const stockLength = ref(6000); // Длина заготовки (в мм)
          const stockQuantity = ref(1); // Количество заготовок
          const details = ref([]); // Список деталей
          const cuttingPlan = ref([]); // Результат раскроя

          // Добавить деталь
          const addDetail = () => {
            details.value.push({
              length: 500,
              quantity: 1,
              comment: "",
            });
          };

          // Удалить деталь
          const removeDetail = (index) => {
            details.value.splice(index, 1);
          };

          // Рассчитать раскрой
          const calculateCutting = () => {
            // Сортировка деталей по длине по убыванию перед расчетом
            details.value.sort((a, b) => b.length - a.length);

            let currentStockIndex = 0;

            // Очистка плана раскроя
            cuttingPlan.value = [];
            for (let i = 0; i < stockQuantity.value; i++) {
              cuttingPlan.value.push({
                segments: [],
                remainder: stockLength.value,
                remainderWidth: 100,
                remainderLeft: 0,
              });
            }

            let totalPlaced = 0; // Количество расположенных деталей

            // Создание копии массива деталей для изменения количества в процессе
            let remainingDetails = details.value.map((detail) => ({
              ...detail,
              remainingQuantity: detail.quantity,
            }));

            while (
              currentStockIndex < stockQuantity.value &&
              remainingDetails.some((detail) => detail.remainingQuantity > 0)
            ) {
              const stock = cuttingPlan.value[currentStockIndex];

              // Поиск первой детали, которая поместится на текущую заготовку
              const fittingDetailIndex = remainingDetails.findIndex(
                (detail) =>
                  detail.remainingQuantity > 0 &&
                  detail.length + gap.value <= stock.remainder
              );

              if (fittingDetailIndex !== -1) {
                // Если нашли деталь, которая помещается
                const detail = remainingDetails[fittingDetailIndex];
                const left = 100 - (stock.remainder / stockLength.value) * 100;
                const width = ((detail.length + gap.value) / stockLength.value) * 100; // Учет зазораs

                stock.segments.push({
                  length: detail.length,
                  width: width,
                  left: left,
                  position: fittingDetailIndex + 1, // Номер позиции
                  comment: detail.comment,
                });

                stock.remainder -= (detail.length + gap.value); // Уменьшаем остаток с учетом зазора
                stock.remainderWidth =
                  (stock.remainder / stockLength.value) * 100;
                stock.remainderLeft = 100 - stock.remainderWidth ;

                // Уменьшаем количество оставшихся деталей
                detail.remainingQuantity--;
                totalPlaced++;
              } else {
                // Если не нашли подходящей детали, переходим к следующей заготовке
                currentStockIndex++;
              }
            }

            // Обновляем количество размещенных деталей
            placedDetails.value = totalPlaced;
          };

          // Общее количество деталей
          const totalDetails = computed(() => {
            return details.value.reduce(
              (sum, detail) => sum + detail.quantity,
              0
            );
          });

          // Общее суммарная длинна деталей
          const totalLength = computed(() => {
            return details.value.reduce(
              (sum, detail) => sum + detail.quantity * detail.length,
              0
            );
          });

          // Подсчет количества деталей
          const countedDetails = computed(() => {
            const counts = {};
            details.value.forEach((detail) => {
              if (!counts[detail.length]) {
                counts[detail.length] = { totalQuantity: 0 };
              }
              counts[detail.length].totalQuantity += detail.quantity;
            });
            return Object.entries(counts).map(([length, data]) => ({
              length: length,
              totalQuantity: data.totalQuantity,
            }));
          });

          // Процент неиспользованных остатков
          const unusedPercentage = computed(() => {
            const totalLength = stockLength.value * stockQuantity.value;
            const usedLength = cuttingPlan.value.reduce((total, stock) => {
              return (
                total +
                stock.segments.reduce(
                  (segTotal, segment) => segTotal + segment.length,
                  0
                )
              );
            }, 0);
            return ((totalLength - usedLength) / totalLength) * 100;
          });

          // Количество размещенных деталей
          const placedDetails = ref(0);

          // Логика для нахождения уникальных планов раскроя
          const uniqueCuttingPlans = computed(() => {
            const uniquePlans = [];
            cuttingPlan.value.forEach((stock) => {
              const existingPlan = uniquePlans.find(
                (plan) =>
                  JSON.stringify(plan.segments) ===
                  JSON.stringify(stock.segments)
              );
              if (existingPlan) {
                existingPlan.repeats++;
              } else {
                uniquePlans.push({ ...stock, repeats: 1 });
              }
            });
            return uniquePlans;
          });

          // Сохранить в CSV (обновлено)
          const saveToCSV = () => {
            const csvContent =
              "data:text/csv;charset=utf-8," +
              "Длина,Количество,Комментарий\n" +
              details.value
                .map(
                  (detail) =>
                    `${detail.length},${detail.quantity},"${detail.comment}"`
                )
                .join("\n");
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "detali.csv");
            document.body.appendChild(link);
            link.click();
          };

          // Загрузить из CSV (обновлено)
          const loadFromCSV = (event) => {
            const file = event.target.files[0];
            const reader = new FileReader();
            reader.onload = (e) => {
              const text = e.target.result;
              const rows = text.split("\n").slice(1); // Пропустить заголовок
              rows.forEach((row) => {
                const [length, quantity, comment] = row.split(",");
                if (length && quantity) {
                  details.value.push({
                    length: parseInt(length),
                    quantity: parseInt(quantity),
                    comment: comment.replace(/"/g, ""), // Удаление кавычек
                  });
                }
              });
            };
            reader.readAsText(file);
          };

          return {
            stockLength,
            stockQuantity,
            details,
            cuttingPlan,
            addDetail,
            removeDetail,
            calculateCutting,
            countedDetails,
            unusedPercentage,
            saveToCSV,
            loadFromCSV,
            placedDetails,
            totalDetails,
            totalLength,
            uniqueCuttingPlans,
            gap,
          };
        },
      }).mount("#app");
    </script>
  </body>
</html>
